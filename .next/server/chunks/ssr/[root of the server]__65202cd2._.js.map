{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 23, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/lib/data-service.ts"],"sourcesContent":["// src/lib/data-service.ts\n'use server';\n\nimport fs from 'fs/promises';\nimport path from 'path';\nimport type { EventData, SaleData, NewSaleDataInternal, UserData, EventCreationData, SettingsData } from './types';\nimport { v4 as uuidv4 } from 'uuid'; \n\nconst dataDir = path.join(process.cwd(), 'src', 'data');\nconst eventsFilePath = path.join(dataDir, 'eventos.json');\nconst salesFilePath = path.join(dataDir, 'vendas.json');\nconst usersFilePath = path.join(dataDir, 'usuarios.json');\nconst settingsFilePath = path.join(dataDir, 'settings.json');\n\n// Helper to read JSON\nasync function readJsonFile<T>(filePath: string, defaultValue?: T): Promise<T> {\n  try {\n    await fs.access(filePath);\n  } catch (error) {\n    if ((error as NodeJS.ErrnoException).code === 'ENOENT') {\n      // If file doesn't exist, create it with default value or empty structure\n      const dataToStore = defaultValue !== undefined ? defaultValue : (filePath.endsWith('s.json') || filePath.endsWith('os.json') ? [] : {});\n      await fs.writeFile(filePath, JSON.stringify(dataToStore, null, 2), 'utf-8');\n      return dataToStore as T;\n    }\n    console.error(`Error accessing file ${filePath}:`, error);\n    throw error; // Re-throw other errors\n  }\n  // File exists, proceed to read and parse\n  try {\n    const jsonData = await fs.readFile(filePath, 'utf-8');\n    return JSON.parse(jsonData) as T;\n  } catch (error) {\n    console.error(`Error reading or parsing JSON from ${filePath}:`, error);\n    // Fallback to default value if provided on read/parse error\n    if (defaultValue !== undefined) return defaultValue;\n    // Specific fallback for list-like files if no default is provided\n    if (filePath.endsWith('s.json') || filePath.endsWith('os.json')) { \n      return [] as T; // Treat as empty list on error if it's a list file\n    }\n    throw error; // Re-throw other errors\n  }\n}\n\n// Helper to write JSON\nasync function writeJsonFile<T>(filePath: string, data: T): Promise<void> {\n  try {\n    const jsonData = JSON.stringify(data, null, 2);\n    await fs.writeFile(filePath, jsonData, 'utf-8');\n  } catch (error) {\n    console.error(`Error writing JSON to ${filePath}:`, error);\n    throw error;\n  }\n}\n\n// Settings functions\nexport async function getSettings(): Promise<SettingsData> {\n  return readJsonFile<SettingsData>(settingsFilePath, { mercadoPagoAccessToken: '' });\n}\n\nexport async function updateSettings(newSettings: Partial<SettingsData>): Promise<SettingsData> {\n  const currentSettings = await getSettings();\n  const updatedSettings = { ...currentSettings, ...newSettings };\n  await writeJsonFile(settingsFilePath, updatedSettings);\n  return updatedSettings;\n}\n\n\n// Event functions\nexport async function getEvents(): Promise<EventData[]> {\n  return readJsonFile<EventData[]>(eventsFilePath, []);\n}\n\nexport async function getEventById(id: string): Promise<EventData | undefined> {\n  const events = await getEvents();\n  return events.find(event => event.id === id);\n}\n\nexport async function getEventsByOrganizerId(organizerId: string): Promise<EventData[]> {\n  const events = await getEvents();\n  return events.filter(event => event.organizer_id === organizerId);\n}\n\nexport async function addEvent(eventDetails: EventCreationData, organizerId: string): Promise<EventData> {\n  const events = await getEvents();\n  \n  const newEvent: EventData = {\n    id: `evt-${uuidv4()}`,\n    organizer_id: organizerId,\n    ...eventDetails, \n    quantidade_disponivel: eventDetails.quantidade_total,\n    imagem_url: eventDetails.imagem_url || undefined,\n    next_sale_reference_number: 1, // Initialize counter\n  };\n  events.push(newEvent);\n  await writeJsonFile(eventsFilePath, events);\n  return newEvent;\n}\n\nexport async function updateEventSaleReferenceCounter(eventId: string, newCounterValue: number): Promise<boolean> {\n    const events = await getEvents();\n    const eventIndex = events.findIndex(event => event.id === eventId);\n\n    if (eventIndex === -1) {\n        console.error(`Event with ID ${eventId} not found for counter update.`);\n        return false;\n    }\n    events[eventIndex].next_sale_reference_number = newCounterValue;\n    await writeJsonFile(eventsFilePath, events);\n    console.log(`Event ${eventId} sale reference counter updated to ${newCounterValue}`);\n    return true;\n}\n\n\nexport async function updateEvent(eventId: string, updates: EventCreationData, currentOrganizerId: string): Promise<EventData | null> {\n  const events = await getEvents();\n  const eventIndex = events.findIndex(event => event.id === eventId);\n\n  if (eventIndex === -1) {\n    console.error(`Event with ID ${eventId} not found for update.`);\n    return null; \n  }\n\n  const currentEvent = events[eventIndex];\n\n  if (currentEvent.organizer_id !== currentOrganizerId) {\n    console.error(`Organizer ${currentOrganizerId} does not have permission to update event ${eventId}.`);\n    return null; \n  }\n\n  const ticketsSold = currentEvent.quantidade_total - currentEvent.quantidade_disponivel;\n\n  if (updates.quantidade_total < ticketsSold) {\n    console.error(`Cannot update event ${eventId}: new total quantity (${updates.quantidade_total}) is less than tickets already sold (${ticketsSold}).`);\n    return null; \n  }\n  \n  const newQuantidadeDisponivel = updates.quantidade_total - ticketsSold;\n\n  const updatedEvent: EventData = {\n    ...currentEvent, \n    ...updates,\n    quantidade_disponivel: newQuantidadeDisponivel,\n    imagem_url: updates.imagem_url || currentEvent.imagem_url, // Preserve existing image if not updated\n    next_sale_reference_number: currentEvent.next_sale_reference_number || 1, // Preserve counter or initialize\n  };\n\n  events[eventIndex] = updatedEvent;\n  await writeJsonFile(eventsFilePath, events);\n  return updatedEvent;\n}\n\n\nexport async function deleteEventAndSalesById(eventId: string): Promise<{success: boolean; message?: string}> {\n  try {\n    let events = await getEvents();\n    const eventExists = events.some(event => event.id === eventId);\n    if (!eventExists) {\n      return { success: false, message: 'Evento não encontrado.' };\n    }\n    events = events.filter(event => event.id !== eventId);\n    await writeJsonFile(eventsFilePath, events);\n\n    let sales = await getAllSales();\n    sales = sales.filter(sale => sale.evento_id !== eventId);\n    await writeJsonFile(salesFilePath, sales);\n    \n    return { success: true };\n  } catch (error) {\n    console.error('Error deleting event and associated sales:', error);\n    return { success: false, message: 'Erro ao excluir evento e vendas associadas.' };\n  }\n}\n\n\n// Sale functions\nexport async function getAllSales(): Promise<SaleData[]> {\n  return readJsonFile<SaleData[]>(salesFilePath, []);\n}\n\nexport async function getSaleById(id: string): Promise<SaleData | undefined> {\n  const sales = await getAllSales();\n  return sales.find(sale => sale.id === id);\n}\n\nexport async function getSaleByMercadoPagoExternalReference(mpExternalRef: string): Promise<SaleData | undefined> {\n  const sales = await getAllSales();\n  return sales.find(sale => sale.mercado_pago_external_reference === mpExternalRef);\n}\n\n\nexport async function addSale(saleData: NewSaleDataInternal): Promise<SaleData> {\n  const sales = await getAllSales();\n  const newSale: SaleData = {\n    id: `sale-${uuidv4().substring(0, 12)}`, // Shortened internal TrinkaPass Sale ID\n    ...saleData,\n    // mercado_pago_external_reference is already part of saleData from initiatePurchaseAction\n  };\n  sales.push(newSale);\n  await writeJsonFile(salesFilePath, sales);\n  return newSale;\n}\n\nexport async function updateSale(saleId: string, updates: Partial<Omit<SaleData, 'id' | 'evento_id' | 'nome_comprador' | 'email_comprador' | 'whatsapp' | 'quantidade' | 'preco_ingresso_unitario' | 'taxa_servico_unitaria' | 'valor_total_item' | 'valor_total_compra' | 'data_compra' | 'pix_copia_cola_mp' | 'mercado_pago_external_reference' >>): Promise<SaleData | null> {\n  const sales = await getAllSales();\n  const saleIndex = sales.findIndex(s => s.id === saleId);\n  if (saleIndex === -1) {\n    console.error(`Sale with ID ${saleId} not found for update.`);\n    return null;\n  }\n  sales[saleIndex] = { ...sales[saleIndex], ...updates };\n  await writeJsonFile(salesFilePath, sales);\n  return sales[saleIndex];\n}\n\n\nexport async function getSalesByEventId(eventId: string): Promise<SaleData[]> {\n  const sales = await getAllSales();\n  return sales.filter(sale => sale.evento_id === eventId);\n}\n\n\nexport async function updateEventStock(eventId: string, quantityChange: number, newAvailableQuantity?: number): Promise<boolean> {\n  const events = await getEvents(); \n  const eventIndex = events.findIndex(event => event.id === eventId);\n  if (eventIndex === -1) {\n    console.error(`Event with ID ${eventId} not found for stock update.`);\n    return false;\n  }\n\n  const currentEvent = events[eventIndex];\n\n  if (newAvailableQuantity !== undefined) {\n    if (newAvailableQuantity < 0 || newAvailableQuantity > currentEvent.quantidade_total) {\n      console.warn(`Invalid newAvailableQuantity ${newAvailableQuantity} for event ${eventId}. Max total: ${currentEvent.quantidade_total}.`);\n      return false;\n    }\n    currentEvent.quantidade_disponivel = newAvailableQuantity;\n  } else {\n    const proposedAvailable = currentEvent.quantidade_disponivel - quantityChange;\n    if (proposedAvailable < 0) {\n      console.warn(`Not enough stock for event ID ${eventId}. Available: ${currentEvent.quantidade_disponivel}, Requested change: ${quantityChange}`);\n      return false;\n    }\n    if (proposedAvailable > currentEvent.quantidade_total) {\n      console.warn(`Proposed available stock ${proposedAvailable} exceeds total quantity ${currentEvent.quantidade_total} for event ${eventId}. Capping at total.`);\n      currentEvent.quantidade_disponivel = currentEvent.quantidade_total;\n    } else {\n      currentEvent.quantidade_disponivel = proposedAvailable;\n    }\n  }\n  \n  events[eventIndex] = currentEvent;\n  await writeJsonFile(eventsFilePath, events);\n  console.log(`Stock for event ${eventId} updated. New available: ${currentEvent.quantidade_disponivel}`);\n  return true;\n}\n\n\n// User functions\nexport async function getUsers(): Promise<UserData[]> {\n return readJsonFile<UserData[]>(usersFilePath, []);\n}\n\nexport async function getUserById(id: string): Promise<UserData | undefined> {\n  const users = await getUsers();\n  return users.find(user => user.id === id);\n}\n\nexport async function getUserByEmail(email: string): Promise<UserData | undefined> {\n  const users = await getUsers();\n  return users.find(user => user.email === email);\n}\n\nexport async function addUser(userData: UserData): Promise<UserData> {\n  const users = await getUsers();\n  users.push(userData);\n  await writeJsonFile(usersFilePath, users);\n  return userData;\n}\n\nexport async function updateUser(userId: string, updates: Partial<Omit<UserData, 'id' | 'tipo'>>): Promise<UserData | null> {\n  const users = await getUsers();\n  const userIndex = users.findIndex(user => user.id === userId);\n\n  if (userIndex === -1) {\n    console.error(`User with ID ${userId} not found for update.`);\n    return null;\n  }\n\n  const updatedUser: UserData = { ...users[userIndex] };\n\n  if (updates.nome !== undefined) updatedUser.nome = updates.nome;\n  if (updates.email !== undefined) updatedUser.email = updates.email;\n  if (updates.whatsapp !== undefined) updatedUser.whatsapp = updates.whatsapp;\n  if (updates.password_hash !== undefined) updatedUser.password_hash = updates.password_hash;\n  \n  // Add updates for PIX key and ID photo\n  if (updates.pix_key_type !== undefined) {\n    updatedUser.pix_key_type = updates.pix_key_type === '' ? undefined : updates.pix_key_type;\n  }\n  if (updates.pix_key !== undefined) {\n     updatedUser.pix_key = updates.pix_key === '' ? undefined : updates.pix_key;\n  }\n  if (updates.id_photo_data_uri !== undefined) {\n    updatedUser.id_photo_data_uri = updates.id_photo_data_uri === '' ? undefined : updates.id_photo_data_uri;\n  }\n\n  users[userIndex] = updatedUser;\n  await writeJsonFile(usersFilePath, users);\n  return updatedUser;\n}\n\nexport async function deleteUserById(userId: string): Promise<{success: boolean; message?: string}> {\n  try {\n    let users = await getUsers();\n    const userExists = users.some(user => user.id === userId);\n    if (!userExists) {\n      return { success: false, message: 'Usuário não encontrado.' };\n    }\n    users = users.filter(user => user.id !== userId);\n    await writeJsonFile(usersFilePath, users);\n    return { success: true };\n  } catch (error) {\n    console.error('Error deleting user:', error);\n    return { success: false, message: 'Erro ao excluir usuário.' };\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 401, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/lib/constants.ts"],"sourcesContent":["// src/lib/constants.ts\nexport const SERVICE_FEE_PER_TICKET = 2.00; // R$ 2,00\n"],"names":[],"mappings":"AAAA,uBAAuB;;;;AAChB,MAAM,yBAAyB,MAAM,UAAU","debugId":null}},
    {"offset": {"line": 412, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/lib/data-service.server.ts"],"sourcesContent":["// This file is intended to re-export functions from data-service.ts\n// that are safe to be called from server components or server actions.\n// In Next.js 13+ with App Router, direct imports from 'data-service.ts'\n// in server components or actions will run on the server.\n// This file is more for logical separation or if you have specific\n// server-only augmentations. For now, it will just re-export.\n// If you have specific server-only logic, it would go here.\n\nimport { \n    getEvents, \n    getEventById, \n    addSale, \n    updateEventStock, \n    getUsers, \n    getUserById, \n    getUserByEmail,\n    addUser,\n    addEvent,\n    updateEvent, \n    updateUser, \n    getEventsByOrganizerId,\n    getSalesByEventId,\n    getAllSales,\n    deleteUserById,\n    deleteEventAndSalesById,\n    getSettings, // Added getSettings\n    updateSettings // Added updateSettings\n} from './data-service';\n\n// Re-export all functions that are intended for server-side use.\n// This makes it explicit that these are server-side operations when imported from this file.\nexport {\n    getEvents, \n    getEventById, \n    addSale, \n    updateEventStock, \n    getUsers, \n    getUserById, \n    getUserByEmail,\n    addUser,\n    addEvent,\n    updateEvent,\n    updateUser, \n    getEventsByOrganizerId,\n    getSalesByEventId,\n    getAllSales,\n    deleteUserById,\n    deleteEventAndSalesById,\n    getSettings, // Export getSettings\n    updateSettings // Export updateSettings\n};\n\n// Example of a server-only function if you needed one that isn't in data-service.ts\n// export async function getSensitiveServerData(): Promise<any> {\n//   // ... server-only logic, e.g. accessing environment variables directly\n//   return { data: \"sensitive server data\" };\n// }\n\n"],"names":[],"mappings":"AAAA,oEAAoE;AACpE,uEAAuE;AACvE,wEAAwE;AACxE,0DAA0D;AAC1D,mEAAmE;AACnE,8DAA8D;AAC9D,4DAA4D;;;;CA8C5D,oFAAoF;CACpF,iEAAiE;CACjE,4EAA4E;CAC5E,8CAA8C;CAC9C,IAAI","debugId":null}},
    {"offset": {"line": 442, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/services/mercado-pago-service.ts"],"sourcesContent":["// src/services/mercado-pago-service.ts\n'use server';\n\nimport { getSettings } from '@/lib/data-service.server';\n\ninterface CreatePixPaymentMPResult {\n  success: boolean;\n  pixCopyPaste?: string;\n  qrCodeBase64?: string; // Base64 string for the QR code image\n  paymentId?: string; // Mercado Pago's payment ID\n  error?: string;\n}\n\nexport interface PaymentStatusMPResult {\n  success: boolean;\n  status?: string; // e.g., 'approved', 'pending_payment', 'rejected', 'cancelled'\n  paymentId?: string;\n  externalReference?: string;\n  error?: string;\n}\n\nexport async function createPixPaymentMP(\n  amount: number,\n  description: string,\n  payerEmail: string,\n  externalReference: string // Your internal sale ID\n): Promise<CreatePixPaymentMPResult> {\n  const appSettings = await getSettings();\n  const accessToken = appSettings.mercadoPagoAccessToken || process.env.MERCADO_PAGO_ACCESS_TOKEN;\n\n  if (!accessToken) {\n    console.error('Mercado Pago Access Token is not configured in settings or environment variables.');\n    return { success: false, error: 'Configuração de pagamento indisponível. Verifique as configurações do administrador.' };\n  }\n\n  // Ensure amount is correctly formatted (e.g., two decimal places for Mercado Pago)\n  const formattedAmount = parseFloat(amount.toFixed(2));\n\n  const paymentData = {\n    transaction_amount: formattedAmount,\n    description: description,\n    payment_method_id: 'pix',\n    payer: {\n      email: payerEmail,\n    },\n    external_reference: externalReference,\n    // notification_url: Set this in your Mercado Pago dashboard if possible, or dynamically if needed\n  };\n\n  try {\n    const response = await fetch('https://api.mercadopago.com/v1/payments', {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'Authorization': `Bearer ${accessToken}`,\n        'X-Idempotency-Key': externalReference, \n      },\n      body: JSON.stringify(paymentData),\n    });\n\n    const responseData = await response.json();\n\n    if (!response.ok) {\n      console.error('Mercado Pago API Error creating payment:', responseData);\n      const errorMessage = responseData.message || `Erro ${response.status} ao criar pagamento PIX.`;\n      let displayMessage = 'Falha ao gerar PIX junto ao Mercado Pago.';\n      if (responseData.cause && Array.isArray(responseData.cause) && responseData.cause.length > 0) {\n        const firstCause = responseData.cause[0];\n        if (firstCause.code && firstCause.description) {\n            if (firstCause.description.includes('payer.email') || firstCause.description.includes('external_reference')) {\n                 displayMessage = `Detalhe do erro: ${firstCause.description}`;\n            }\n        }\n      } else if (errorMessage.includes('transaction_amount')) {\n        displayMessage = 'Valor da transação inválido para o Mercado Pago.'\n      }\n      return { success: false, error: displayMessage };\n    }\n    \n    const pixCopyPaste = responseData.point_of_interaction?.transaction_data?.qr_code;\n    const qrCodeBase64 = responseData.point_of_interaction?.transaction_data?.qr_code_base64;\n    const paymentId = responseData.id?.toString();\n\n\n    if (!pixCopyPaste) {\n        console.error('Mercado Pago API did not return PIX copy/paste code:', responseData);\n        return { success: false, error: 'Não foi possível obter o código PIX Copia e Cola do Mercado Pago.' };\n    }\n\n    return {\n      success: true,\n      pixCopyPaste,\n      qrCodeBase64,\n      paymentId,\n    };\n\n  } catch (error) {\n    console.error('Network or other error creating Mercado Pago PIX payment:', error);\n    return { success: false, error: 'Erro de comunicação ao tentar gerar PIX. Tente novamente.' };\n  }\n}\n\n\nexport async function getPaymentStatusMP(mpPaymentId: string): Promise<PaymentStatusMPResult> {\n  const appSettings = await getSettings();\n  const accessToken = appSettings.mercadoPagoAccessToken || process.env.MERCADO_PAGO_ACCESS_TOKEN;\n\n  if (!accessToken) {\n    console.error('Mercado Pago Access Token is not configured.');\n    return { success: false, error: 'Configuração de pagamento indisponível.' };\n  }\n\n  if (!mpPaymentId) {\n    return { success: false, error: 'ID do Pagamento Mercado Pago não fornecido.' };\n  }\n\n  try {\n    console.log(`Fetching payment status for MP Payment ID: ${mpPaymentId}`);\n    const response = await fetch(`https://api.mercadopago.com/v1/payments/${mpPaymentId}`, {\n      method: 'GET',\n      headers: {\n        'Authorization': `Bearer ${accessToken}`,\n      },\n    });\n\n    const responseData = await response.json();\n    console.log(`MP API Response for ${mpPaymentId} status: ${response.status}`, responseData);\n\n\n    if (!response.ok) {\n      console.error(`Mercado Pago API Error fetching payment status for ID ${mpPaymentId}:`, responseData);\n      return { \n        success: false, \n        error: responseData.message || `Erro ${response.status} ao buscar status do pagamento.`,\n        paymentId: mpPaymentId \n      };\n    }\n    \n    return {\n      success: true,\n      status: responseData.status,\n      paymentId: responseData.id?.toString(),\n      externalReference: responseData.external_reference,\n    };\n\n  } catch (error) {\n    console.error(`Network or other error fetching Mercado Pago payment status for ID ${mpPaymentId}:`, error);\n    return { \n      success: false, \n      error: 'Erro de comunicação ao verificar status do pagamento.',\n      paymentId: mpPaymentId\n    };\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 593, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/app/actions/purchase-actions.ts"],"sourcesContent":["// src/app/actions/purchase-actions.ts\n'use server';\n\nimport { \n  addSale, \n  getEventById, \n  updateEventStock, \n  getUserById, \n  getSaleById, // Keep for direct sale lookup if needed elsewhere, but webhook will use mpExternalRef\n  updateSale,\n  updateEventSaleReferenceCounter, // New function to update event counter\n  getSaleByMercadoPagoExternalReference \n} from '@/lib/data-service';\nimport type { PurchaseInitiationData, SaleData, UserData, NewSaleDataInternal, CheckPaymentStatusResult, InitiatePurchaseResult } from '@/lib/types';\nimport { SERVICE_FEE_PER_TICKET } from '@/lib/constants';\nimport { createPixPaymentMP, getPaymentStatusMP } from '@/services/mercado-pago-service';\n// import { v4 as uuidv4 } from 'uuid'; // No longer needed for tempSaleId if mpExternalReference is the primary external key for MP\nimport { revalidatePath } from 'next/cache';\n\nexport async function initiatePurchaseAction(purchaseData: PurchaseInitiationData): Promise<InitiatePurchaseResult> {\n  try {\n    const event = await getEventById(purchaseData.evento_id);\n    if (!event) {\n      return { success: false, error: 'Evento não encontrado.' };\n    }\n    if (event.quantidade_disponivel < purchaseData.quantidade) {\n      return { success: false, error: 'Ingressos insuficientes disponíveis.' };\n    }\n\n    // Generate sequential external reference for Mercado Pago\n    const currentCounter = event.next_sale_reference_number || 1;\n    const eventIdPart = event.id.startsWith('evt-') ? event.id.substring(4, 12) : event.id.substring(0,8);\n    const mercadoPagoExternalReference = `TRK-${eventIdPart}-${String(currentCounter).padStart(9, '0')}`;\n\n    const precoIngressoUnitario = event.preco_ingresso;\n    const taxaServicoUnitaria = SERVICE_FEE_PER_TICKET;\n    const valorTotalItem = precoIngressoUnitario + taxaServicoUnitaria;\n    const valorTotalCompra = valorTotalItem * purchaseData.quantidade;\n\n    const mpResult = await createPixPaymentMP(\n      valorTotalCompra,\n      `Ingressos para ${event.nome_evento} (TrinkaPass)`,\n      purchaseData.email_comprador,\n      mercadoPagoExternalReference // Use the new sequential reference for MP\n    );\n\n    if (!mpResult.success || !mpResult.pixCopyPaste || !mpResult.paymentId) {\n      return { success: false, error: mpResult.error || 'Falha ao gerar PIX com o Mercado Pago.' };\n    }\n\n    // Update event counter after successful MP PIX generation\n    const counterUpdated = await updateEventSaleReferenceCounter(event.id, currentCounter + 1);\n    if (!counterUpdated) {\n      console.error(`CRITICAL: Failed to update sale reference counter for event ${event.id} after MP PIX generation. Expected next: ${currentCounter + 1}`);\n    }\n\n    const newSaleRecord: NewSaleDataInternal = {\n      evento_id: purchaseData.evento_id,\n      nome_comprador: purchaseData.nome_comprador,\n      email_comprador: purchaseData.email_comprador,\n      whatsapp: purchaseData.whatsapp,\n      quantidade: purchaseData.quantidade,\n      preco_ingresso_unitario: precoIngressoUnitario,\n      taxa_servico_unitaria: taxaServicoUnitaria,\n      valor_total_item: valorTotalItem,\n      valor_total_compra: valorTotalCompra,\n      data_compra: new Date().toISOString(),\n      status: 'pending_payment', \n      pix_copia_cola_mp: mpResult.pixCopyPaste,\n      mp_payment_id: mpResult.paymentId, \n      mercado_pago_external_reference: mercadoPagoExternalReference,\n    };\n\n    const createdSale = await addSale(newSaleRecord); \n    \n    return {\n      success: true,\n      pixCopyPaste: mpResult.pixCopyPaste,\n      qrCodeBase64: mpResult.qrCodeBase64,\n      saleId: createdSale.id, \n      totalAmount: valorTotalCompra,\n      mpPaymentId: mpResult.paymentId,\n      mpExternalReference: mercadoPagoExternalReference, \n    };\n\n  } catch (error) {\n    console.error('Error initiating purchase:', error);\n    let errorMessage = 'Ocorreu um erro ao iniciar sua compra.';\n    if (error instanceof Error) {\n      errorMessage = error.message;\n    }\n    return { success: false, error: errorMessage };\n  }\n}\n\nexport async function checkPaymentStatusAction(mpPaymentId: string, mpExternalReference?: string): Promise<CheckPaymentStatusResult> {\n  if (!mpPaymentId) {\n    return { success: false, message: 'ID do Pagamento do Mercado Pago não fornecido.' };\n  }\n\n  try {\n    const mpApiResult = await getPaymentStatusMP(mpPaymentId);\n\n    if (!mpApiResult.success || !mpApiResult.status) {\n      return { \n        success: false, \n        message: mpApiResult.error || 'Falha ao verificar status do pagamento com Mercado Pago.',\n        mpPaymentId: mpPaymentId,\n        saleId: mpExternalReference || mpApiResult.externalReference \n      };\n    }\n\n    let userMessage = `Status do Pagamento: ${mpApiResult.status}`;\n    let organizerWhatsAppNumber: string | undefined;\n    let prefilledWhatsAppMessageToOrganizer: string | undefined;\n    \n    const effectiveExternalReference = mpApiResult.externalReference || mpExternalReference;\n\n    if (mpApiResult.status === 'approved' && effectiveExternalReference) {\n      const saleToConfirm = await getSaleByMercadoPagoExternalReference(effectiveExternalReference);\n      if (saleToConfirm) {\n        if (saleToConfirm.status === 'pending_payment') {\n          console.log(`checkPaymentStatusAction: Confirming sale ${saleToConfirm.id} (MP Ext Ref: ${effectiveExternalReference}) based on MP status 'approved'. Current DB status: '${saleToConfirm.status}'.`);\n          const updatedSale = await updateSale(saleToConfirm.id, {\n              status: 'paid',\n              data_pagamento_confirmado: new Date().toISOString(),\n              mp_payment_id: mpApiResult.paymentId, \n          });\n\n          if (updatedSale) {\n              console.log(`checkPaymentStatusAction: Sale ${updatedSale.id} status updated to 'paid'. Updating stock.`);\n              const stockUpdated = await updateEventStock(updatedSale.evento_id, updatedSale.quantidade);\n              if (!stockUpdated) {\n                  console.error(`checkPaymentStatusAction: CRITICAL - Failed to update stock for event ${updatedSale.evento_id} after sale ${updatedSale.id} confirmation.`);\n              } else {\n                  console.log(`checkPaymentStatusAction: Stock for event ${updatedSale.evento_id} updated.`);\n              }\n              revalidatePath('/');\n              revalidatePath(`/event/${updatedSale.evento_id}`);\n              revalidatePath('/admin/dashboard'); \n              revalidatePath(`/admin/events/${updatedSale.evento_id}/buyers`); \n              revalidatePath('/organizer/dashboard'); \n              revalidatePath(`/organizer/events/${updatedSale.evento_id}/buyers`); \n              console.log(`checkPaymentStatusAction: Paths revalidated for sale ${updatedSale.id}.`);\n          } else {\n               console.error(`checkPaymentStatusAction: Failed to update sale ${saleToConfirm.id} in DB.`);\n          }\n        } else {\n            console.log(`checkPaymentStatusAction: Sale ${saleToConfirm.id} (MP Ext Ref: ${effectiveExternalReference}) is already in status '${saleToConfirm.status}'. No DB update needed by manual check.`);\n        }\n        \n        // Prepare WhatsApp info regardless of DB update if MP says approved\n        const event = await getEventById(saleToConfirm.evento_id);\n        if (event && event.organizer_id) {\n            const organizer = await getUserById(event.organizer_id);\n            if (organizer && organizer.whatsapp) {\n                organizerWhatsAppNumber = `55${organizer.whatsapp.replace(/\\D/g, '')}`;\n                prefilledWhatsAppMessageToOrganizer = \n`Olá ${organizer.nome || 'Organizador(a)'},\nUma compra de ${saleToConfirm.quantidade} ingresso(s) para o seu evento \"${event.nome_evento}\" (TrinkaPass) foi APROVADA!\nReferência da Compra (Mercado Pago): ${effectiveExternalReference}.\nID da Venda (TrinkaPass): ${saleToConfirm.id}.\nValor total da compra: R$ ${saleToConfirm.valor_total_compra.toFixed(2).replace('.', ',')}.\nNome do Comprador: ${saleToConfirm.nome_comprador}.\nObrigado(a)!`;\n            }\n        }\n      } else {\n          console.warn(`checkPaymentStatusAction: Sale with MP External Reference ${effectiveExternalReference} not found, but MP API reported 'approved'.`);\n          // User message will be set below if not 'approved'\n      }\n      userMessage = 'Pagamento Aprovado!'; // This is the primary message if MP status is 'approved'\n    } else { // Handle non-approved statuses from MP\n        switch (mpApiResult.status) {\n        case 'pending_payment':\n        case 'in_process':\n        case 'pending':\n            userMessage = 'Pagamento ainda está pendente ou em processamento.';\n            break;\n        case 'rejected':\n            userMessage = 'Pagamento Rejeitado.';\n            break;\n        case 'cancelled':\n            userMessage = 'Pagamento Cancelado.';\n            break;\n        case 'refunded':\n            userMessage = 'Pagamento Estornado.';\n            break;\n        case 'charged_back':\n            userMessage = 'Pagamento Revertido (Chargeback).';\n            break;\n        default:\n            userMessage = `Status do pagamento: ${mpApiResult.status || 'Desconhecido'}. Aguarde a confirmação.`;\n        }\n    }\n\n    return {\n      success: true,\n      paymentStatus: mpApiResult.status, // Return the actual status from MP API\n      message: userMessage,\n      saleId: effectiveExternalReference, \n      mpPaymentId: mpApiResult.paymentId,\n      organizerWhatsAppNumber,\n      prefilledWhatsAppMessageToOrganizer,\n    };\n\n  } catch (error) {\n    console.error(`Error in checkPaymentStatusAction for MP Payment ID ${mpPaymentId}:`, error);\n    return { \n      success: false, \n      message: 'Ocorreu um erro interno ao verificar o status do pagamento.',\n      mpPaymentId: mpPaymentId,\n      saleId: mpExternalReference\n    };\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 813, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 935, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/components/purchase-form.tsx/proxy.mjs"],"sourcesContent":["import { registerClientReference } from \"react-server-dom-turbopack/server.edge\";\nexport default registerClientReference(\n    function() { throw new Error(\"Attempted to call the default export of [project]/src/components/purchase-form.tsx <module evaluation> from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/src/components/purchase-form.tsx <module evaluation>\",\n    \"default\",\n);\n"],"names":[],"mappings":";;;AAAA;;uCACe,CAAA,GAAA,qPAAA,CAAA,0BAAuB,AAAD,EACjC;IAAa,MAAM,IAAI,MAAM;AAAoS,GACjU,kEACA","debugId":null}},
    {"offset": {"line": 949, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/components/purchase-form.tsx/proxy.mjs"],"sourcesContent":["import { registerClientReference } from \"react-server-dom-turbopack/server.edge\";\nexport default registerClientReference(\n    function() { throw new Error(\"Attempted to call the default export of [project]/src/components/purchase-form.tsx from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/src/components/purchase-form.tsx\",\n    \"default\",\n);\n"],"names":[],"mappings":";;;AAAA;;uCACe,CAAA,GAAA,qPAAA,CAAA,0BAAuB,AAAD,EACjC;IAAa,MAAM,IAAI,MAAM;AAAgR,GAC7S,8CACA","debugId":null}},
    {"offset": {"line": 963, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 973, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/lib/utils.ts"],"sourcesContent":["import { clsx, type ClassValue } from \"clsx\"\nimport { twMerge } from \"tailwind-merge\"\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs))\n}\n"],"names":[],"mappings":";;;AAAA;AACA;;;AAEO,SAAS,GAAG,GAAG,MAAoB;IACxC,OAAO,CAAA,GAAA,2JAAA,CAAA,UAAO,AAAD,EAAE,CAAA,GAAA,qIAAA,CAAA,OAAI,AAAD,EAAE;AACtB","debugId":null}},
    {"offset": {"line": 989, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/components/ui/card.tsx"],"sourcesContent":["import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Card = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"rounded-lg border bg-card text-card-foreground shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nCard.displayName = \"Card\"\n\nconst CardHeader = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\n    {...props}\n  />\n))\nCardHeader.displayName = \"CardHeader\"\n\nconst CardTitle = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"text-2xl font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nCardTitle.displayName = \"CardTitle\"\n\nconst CardDescription = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nCardDescription.displayName = \"CardDescription\"\n\nconst CardContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName = \"CardContent\"\n\nconst CardFooter = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex items-center p-6 pt-0\", className)}\n    {...props}\n  />\n))\nCardFooter.displayName = \"CardFooter\"\n\nexport { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }\n"],"names":[],"mappings":";;;;;;;;;AAAA;AAEA;;;;AAEA,MAAM,qBAAO,CAAA,GAAA,qMAAA,CAAA,aAAgB,AAAD,EAG1B,CAAC,EAAE,SAAS,EAAE,GAAG,OAAO,EAAE,oBAC1B,8OAAC;QACC,KAAK;QACL,WAAW,CAAA,GAAA,mHAAA,CAAA,KAAE,AAAD,EACV,4DACA;QAED,GAAG,KAAK;;;;;;AAGb,KAAK,WAAW,GAAG;AAEnB,MAAM,2BAAa,CAAA,GAAA,qMAAA,CAAA,aAAgB,AAAD,EAGhC,CAAC,EAAE,SAAS,EAAE,GAAG,OAAO,EAAE,oBAC1B,8OAAC;QACC,KAAK;QACL,WAAW,CAAA,GAAA,mHAAA,CAAA,KAAE,AAAD,EAAE,iCAAiC;QAC9C,GAAG,KAAK;;;;;;AAGb,WAAW,WAAW,GAAG;AAEzB,MAAM,0BAAY,CAAA,GAAA,qMAAA,CAAA,aAAgB,AAAD,EAG/B,CAAC,EAAE,SAAS,EAAE,GAAG,OAAO,EAAE,oBAC1B,8OAAC;QACC,KAAK;QACL,WAAW,CAAA,GAAA,mHAAA,CAAA,KAAE,AAAD,EACV,sDACA;QAED,GAAG,KAAK;;;;;;AAGb,UAAU,WAAW,GAAG;AAExB,MAAM,gCAAkB,CAAA,GAAA,qMAAA,CAAA,aAAgB,AAAD,EAGrC,CAAC,EAAE,SAAS,EAAE,GAAG,OAAO,EAAE,oBAC1B,8OAAC;QACC,KAAK;QACL,WAAW,CAAA,GAAA,mHAAA,CAAA,KAAE,AAAD,EAAE,iCAAiC;QAC9C,GAAG,KAAK;;;;;;AAGb,gBAAgB,WAAW,GAAG;AAE9B,MAAM,4BAAc,CAAA,GAAA,qMAAA,CAAA,aAAgB,AAAD,EAGjC,CAAC,EAAE,SAAS,EAAE,GAAG,OAAO,EAAE,oBAC1B,8OAAC;QAAI,KAAK;QAAK,WAAW,CAAA,GAAA,mHAAA,CAAA,KAAE,AAAD,EAAE,YAAY;QAAa,GAAG,KAAK;;;;;;AAEhE,YAAY,WAAW,GAAG;AAE1B,MAAM,2BAAa,CAAA,GAAA,qMAAA,CAAA,aAAgB,AAAD,EAGhC,CAAC,EAAE,SAAS,EAAE,GAAG,OAAO,EAAE,oBAC1B,8OAAC;QACC,KAAK;QACL,WAAW,CAAA,GAAA,mHAAA,CAAA,KAAE,AAAD,EAAE,8BAA8B;QAC3C,GAAG,KAAK;;;;;;AAGb,WAAW,WAAW,GAAG","debugId":null}},
    {"offset": {"line": 1070, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/components/ui/separator.tsx/proxy.mjs"],"sourcesContent":["import { registerClientReference } from \"react-server-dom-turbopack/server.edge\";\nexport const Separator = registerClientReference(\n    function() { throw new Error(\"Attempted to call Separator() from the server but Separator is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/src/components/ui/separator.tsx <module evaluation>\",\n    \"Separator\",\n);\n"],"names":[],"mappings":";;;AAAA;;AACO,MAAM,YAAY,CAAA,GAAA,qPAAA,CAAA,0BAAuB,AAAD,EAC3C;IAAa,MAAM,IAAI,MAAM;AAAkO,GAC/P,iEACA","debugId":null}},
    {"offset": {"line": 1084, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/components/ui/separator.tsx/proxy.mjs"],"sourcesContent":["import { registerClientReference } from \"react-server-dom-turbopack/server.edge\";\nexport const Separator = registerClientReference(\n    function() { throw new Error(\"Attempted to call Separator() from the server but Separator is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/src/components/ui/separator.tsx\",\n    \"Separator\",\n);\n"],"names":[],"mappings":";;;AAAA;;AACO,MAAM,YAAY,CAAA,GAAA,qPAAA,CAAA,0BAAuB,AAAD,EAC3C;IAAa,MAAM,IAAI,MAAM;AAAkO,GAC/P,6CACA","debugId":null}},
    {"offset": {"line": 1098, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 1108, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/components/ui/badge.tsx"],"sourcesContent":["import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  \"inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"border-transparent bg-primary text-primary-foreground hover:bg-primary/80\",\n        secondary:\n          \"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80\",\n        destructive:\n          \"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80\",\n        outline: \"text-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nexport interface BadgeProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, ...props }: BadgeProps) {\n  return (\n    <div className={cn(badgeVariants({ variant }), className)} {...props} />\n  )\n}\n\nexport { Badge, badgeVariants }\n"],"names":[],"mappings":";;;;;AACA;AAEA;;;;AAEA,MAAM,gBAAgB,CAAA,GAAA,gKAAA,CAAA,MAAG,AAAD,EACtB,0KACA;IACE,UAAU;QACR,SAAS;YACP,SACE;YACF,WACE;YACF,aACE;YACF,SAAS;QACX;IACF;IACA,iBAAiB;QACf,SAAS;IACX;AACF;AAOF,SAAS,MAAM,EAAE,SAAS,EAAE,OAAO,EAAE,GAAG,OAAmB;IACzD,qBACE,8OAAC;QAAI,WAAW,CAAA,GAAA,mHAAA,CAAA,KAAE,AAAD,EAAE,cAAc;YAAE;QAAQ,IAAI;QAAa,GAAG,KAAK;;;;;;AAExE","debugId":null}},
    {"offset": {"line": 1150, "column": 0}, "map": {"version":3,"sources":["file:///home/user/studio/src/app/event/%5Bid%5D/page.tsx"],"sourcesContent":["import * as React from 'react'; \nimport { getEventById } from '@/lib/data-service';\nimport type { EventData } from '@/lib/types';\nimport Image from 'next/image';\nimport { CalendarDays, MapPin, DollarSign, Ticket, Users, Building, Home as HomeIcon, Info } from 'lucide-react'; // Added HomeIcon and Info\nimport PurchaseForm from '@/components/purchase-form';\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';\nimport { Separator } from '@/components/ui/separator';\nimport { Badge } from '@/components/ui/badge';\n\ninterface EventPageParams {\n  params: { id: string };\n}\n\nexport default async function EventPage({ params }: EventPageParams) {\n  const event = await getEventById(params.id);\n\n  if (!event) {\n    return (\n      <div className=\"text-center py-12\">\n        <h1 className=\"text-3xl font-bold text-destructive\">Evento não encontrado</h1>\n        <p className=\"text-muted-foreground mt-2\">O evento que você está procurando não existe ou foi removido.</p>\n      </div>\n    );\n  }\n\n  const eventDate = new Date(event.data_horario);\n  const timeZone = 'America/Sao_Paulo'; \n\n  const formattedDate = eventDate.toLocaleDateString('pt-BR', {\n    day: '2-digit',\n    month: 'long',\n    year: 'numeric',\n    timeZone,\n  });\n  const formattedTime = eventDate.toLocaleTimeString('pt-BR', {\n    hour: '2-digit',\n    minute: '2-digit',\n    timeZone,\n  });\n\n  const isSoldOut = event.quantidade_disponivel <= 0;\n\n  return (\n    <div className=\"container mx-auto max-w-4xl py-8 px-4\">\n      <Card className=\"overflow-hidden shadow-xl\">\n        <div className=\"relative h-72 w-full\">\n          <Image\n            src={event.imagem_url || `https://picsum.photos/seed/${event.id}/800/400`}\n            alt={event.nome_evento}\n            layout=\"fill\"\n            objectFit=\"cover\"\n            priority\n            data-ai-hint=\"event detail banner\"\n          />\n        </div>\n        <CardHeader className=\"p-6\">\n          <CardTitle className=\"text-4xl font-bold text-primary\">{event.nome_evento}</CardTitle>\n        </CardHeader>\n        <CardContent className=\"p-6 space-y-6\">\n          <p className=\"text-lg text-foreground leading-relaxed\">{event.descricao}</p>\n          \n          <Separator />\n\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6 text-foreground\">\n            <div className=\"space-y-3\">\n              <InfoItem icon={<CalendarDays />} label=\"Data e Hora\" value={`${formattedDate} às ${formattedTime}`} />\n              {event.nome_local_evento && <InfoItem icon={<HomeIcon />} label=\"Nome do Local\" value={event.nome_local_evento} />}\n              {event.cep && <InfoItem icon={<Info />} label=\"CEP\" value={event.cep} />}\n              <InfoItem icon={<MapPin />} label=\"Endereço\" value={event.local} />\n              <InfoItem icon={<Building />} label=\"Cidade\" value={event.cidade} />\n            </div>\n            <div className=\"space-y-3\">\n              <InfoItem icon={<DollarSign />} label=\"Preço\" value={`R$ ${event.preco_ingresso.toFixed(2).replace('.', ',')}`} />\n              <InfoItem icon={<Users />} label=\"Ingressos Disponíveis\" value={`${event.quantidade_disponivel}`} badge={isSoldOut ? \"Esgotado\" : (event.quantidade_disponivel < 20 ? \"Últimos ingressos\" : undefined)} badgeVariant={isSoldOut ? \"destructive\" : (event.quantidade_disponivel < 20 ? \"default\" : undefined)} />\n            </div>\n          </div>\n\n          <Separator />\n          \n          {isSoldOut ? (\n            <div className=\"text-center py-6 bg-muted rounded-md\">\n              <p className=\"text-2xl font-semibold text-destructive\">Ingressos Esgotados!</p>\n              <p className=\"text-muted-foreground\">Não há mais ingressos disponíveis para este evento.</p>\n            </div>\n          ) : (\n            <PurchaseForm event={event} />\n          )}\n\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n\ninterface InfoItemProps {\n  icon: React.ReactNode;\n  label: string;\n  value: string;\n  badge?: string;\n  badgeVariant?: \"default\" | \"secondary\" | \"destructive\" | \"outline\";\n}\n\nfunction InfoItem({ icon, label, value, badge, badgeVariant }: InfoItemProps) {\n  return (\n    <div className=\"flex items-start\">\n      <span className=\"text-primary mt-1 mr-3 shrink-0\">{React.cloneElement(icon as React.ReactElement, { className: 'h-6 w-6' })}</span>\n      <div>\n        <p className=\"font-semibold text-foreground\">{label}</p>\n        <p className=\"text-muted-foreground\">{value} {badge && <Badge variant={badgeVariant} className=\"ml-2\">{badge}</Badge>}</p>\n      </div>\n    </div>\n  );\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}